<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang="ru"><head>
<meta http-equiv="Content-Language" content="ru">
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
<title>DePan и DePanEstimate плагины для Avisynth. Работа с глобальным движением.</title>
<link rel="stylesheet" type="text/css" href="../avisynth.css">
</head>
<body>
<h1>DePan & DePanEstimate</h1>

<h3>Cредства
для оценки и компенсации глобального движения (панорамирования)
</h3>


<p>Плагины для <a href="http://www.avisynth.org">AviSynth 2.5</a><br>
Copyright (C)2004-2016 Александр Г. Балахнин aka Fizick.<br>
<a href="http://avisynth.org.ru">http://avisynth.org.ru</a> </p>

<h2>Введение</h2>

<p> 
Данный пакет содержит средства (функции) для оценки глобального движения (панорамирования - проводки
камеры, а также зума) в кадрах, и для полной или частичной его компенсации.  <br>
</p>

<p>Он может быть использован для:<br>
- компенсации глобального движения в соседних кадрах для сильного временного 
шумопонижения и реставрации;<br>
- воссоздания поврежденных кадров путем интерполяции глобального
движения;<br>
-
создания последовательности промежуточных кадров для изменения частоты
кадров;<br>
- частичной стабилизации движения.
</p>

<p>
Плагин DePan заменил мой экспериментальный  GenMotion C-плагин (который
использовал готовые данные о движении из лог файла VirtualDub плагина
Deshaker).</p>

<p>
Пакет работает в один проход, он состоит из серверной части (функции DePanEstimate) и одной
или более клиентских частей (функций или их копий). Серверная
функция оценивает данные по движению для кадров и передает их
клиентским функциям по запросу. 
В качестве контейнера для данных по движению используется специальный служебный клип.</p>

<h2>&nbsp;&nbsp;&nbsp;
Функции плагина DePanEstimate:</h2>

<h3>&nbsp;&nbsp;&nbsp;
Функция DePanEstimate</h3>

<p>&nbsp;&nbsp;&nbsp;
Эта функция использует метод фазового сдвига (путем быстрого
преобразования Фурье - FFT) для оценки глобального движения.<br>
Она использует некоторую центральную область каждого кадра (или поля) как
окно FFT, чтобы найти межкадровую корреляцию и вычислить наиболее подходящие величины<br>
вертикальных
и горизонтальных сдвигов, которые подгоняют текущий кадр к предыдущему.<br>
Некоторый
относительный параметр корреляции используется как мера доверия и для
обнаружения смены сцен.<br>
В режиме
вычисления зума, функция использует два окна в левой и правой части
кадра чтобы оценить смещения и зум.<br>
Выход функции - специальный служебный клип с закодированными в кадрах данными
по движению, а также файл лога (протокола) с данными по движению.<br>
</p>

<h4>Вызов:
</h4>

<p><code>DePanEstimate</code> ( <var>clip,
int range, float trust, int winx, int winy, int wleft, int wtop, int dxmax, int dymax, float
zoommax, float stab, float pixaspect, bool info, string
log, bool debug, bool show, string extlog, bool fftw</var>)</p>

<h4>Параметры DePanEstimate:</h4>
<p>

<var>clip</var>
- входной клип;<br>

<var>range</var>
- число предыдущих (и также последующих) кадров (полей) подряд для
оценки движения<br>
 (целое число &gt;=0, по умолчанию=0);<br>


<var>trust</var>
- порог относительного превышения максимума корреляции над средним по
спектру значением<br>
&nbsp;&nbsp;&nbsp;&nbsp;
при смене сцены (от 0.0 до 100.0, по умолчанию=4.0);<br>


<var>winx</var>
- ширина окна FFT (по умолчанию - максимально возможная
степень 2);<br>


<var>winy</var>
- высота окна FFT 
(по умолчанию - максимально возможная степень 2);<br>

<var>
wleft</var> - левый отступ окна fft (по умолчанию = -1 для авто-центрирования).<br>

<var>
wtop</var> - верхний отступ окна fft window (по умолчанию = -1 для авто-центрирования).<br>


<var>dxmax</var>
- предел смещения по горизонтали ( по умолчанию=-1 для <var>winx</var>/4);<br>

<var>dymax</var>
- предел смещения по вертикали ( по умолчанию=-1 для <var>winy</var>/4);<br>

<var>zoommax</var>
- максимальный зум-фактор,  если  = 1 (по умолчанию),
то зум не оценивается;
<br>

<var>stab</var>
-  снижает вычисленную корреляцию для больших смещений (
множитель вида <var>dxmax</var>/(<var>dxmax</var>
+ <var>stab</var>*abs(dx))
):<br>
&nbsp;&nbsp;&nbsp;
=0.0  - не снижать,<br>
&nbsp;&nbsp;&nbsp;&nbsp;=1.0 (по умолчанию) - снижать наполовину для смещений <var>dxmax</var>,
<var>dymax</var>.<br>

<var>pixaspect</var>
- аспект (вытянутость) пиксела (по
умолчанию= 1.0);<br>


<var>info</var>
- показать ли информацию по движению на кадре ( по умолчанию= true, да);<br>

<var>log</var>
- имя создаваемого выходного лог-файла протокола с данными по движению<br>
&nbsp;&nbsp;&nbsp;&nbsp;
(в формате VirtualDub плагина Deshaker ) (по умолчанию не
создается);<br>

<var>debug</var>
- выводить ли отладочные данные для утилиты  DebugView 
(по умолчанию = false, нет );<br>

<var>show</var>
- показывать корреляционную поверхность (по умолчанию = false, нет )<br>

<var>extlog</var>
- имя создаваемого выходного расширенного лог-файла протокола с данными по движению<br>
&nbsp;&nbsp;&nbsp;&nbsp;
и пареметру корреляции Trust (по умолчанию не
создается);<br>

<var>fftw</var>
- использовать внешнюю библиотеку FFTW (всегда true с версии 1.9)
</p>

<p>Замечание. Параметр <i>trust </i>определяет некоторую
пороговую величину межкадрового подобия (корреляции). Он определяет,
насколько подобен должен быть текущей кадр предыдущему в той же сцене.
DePanEstimate зарегистрирует смену сцены для текущего кадра, если текущая
величина корреляции ниже данного порога. Установите его ниже чтобы
предотвратить ошибочное детектирование смены сцен, установите его выше
чтобы предотвратить пропуск настоящих смен сцен (с тряской).   
Значение по умолчанию вполне подходит для большинства видео, но вы
можете проверить это, включив режим <i>info.</i>
</p>

<h2>&nbsp;&nbsp;&nbsp;
Функции плагина DePan:</h2>
<p>
DePan (клиент) - делает полную или частичную компенсацию глобального
движения<br> 

DePanInterleave (клиент) - генерирует длинный клип с чередующимися 
компенсированными кадрами<br>

DePanStabilize (клиент) - делает частичную стабилизацию движения<br>

DePanScenes(клиент) - отмечает изменение сцен<br>
</p>
<h3>Функция DePan</h3>

<p> Генерирует клип, в
котором глобальное движение полностью или частично скомпенсировано,<br>
используя данные по движению, вычисляемые функцией DePanEstimate (или
из лог-файла).</p>

<h4>Вызов:<br>
</h4>

<p><code>DePan</code> (<var>clip, clip data, float offset, int subpixel, float pixaspect, bool matchfields, int mirror, int blur, bool info, string inputlog</var>)  <br>
</p>

<h4> Параметры DePan:</h4>

<p>
<var>clip</var>
- входной клип (тот же самый что и для DePanEstimate);<br>


<var>data</var>
- специальный служебный клип с данными по движению, производимый
DePanEstimate;<br>


<var>offset</var>
- величина смещения для компенсации движения входных кадров (полей) (по
умолчанию =0)<br>
 = 0 значит отсутствие изменений;<br>
 = -1.0 значит полная компенсация назад, следующего (n+1)
кадра (поля) к текущему (n);<br>
 = 1.0 значит полная компенсация вперед, предыдущего (n-1) кадра
(поля) к текущему (n);<br>
 = -0.5 значит частичная
компенсация назад, следующего (n+1) кадра
(поля) к текущему (n)
наполовину ;<br>
 = 0.5 значит частичная
компенсация вперед, предыдущего (n-1) кадра
(поля) к текущему (n) наполовину;<br>
 = 0.3333333 значит частичная
компенсация вперед, предыдущего (n-1) кадра
(поля) к текущему (n) на одну треть;<br>
 = -1.5 значит частичная компенсация назад, следующего следующего (n+2)
кадра (поля) к текущему (n) наполовину;<br>
 = 2.0 значит полная
компенсация вперед, предыдущего предыдущего (n-2)
кадра (поля) к текущему (n);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
и т.д. и т.п.<br>


<var>subpixel</var>
- точность интерполяции пикселов (точек) при компенсации движения (по
умолчанию = 2):<br>
&nbsp;&nbsp;&nbsp;
0 - по ближайшему исходному пикселу, без интерполяции (быстрая);<br>
&nbsp;&nbsp;&nbsp; 1 - субпиксельная точность с билинейной
интерполяцией (сглаженная);<br>
&nbsp;&nbsp;&nbsp; 2 - субпиксельная точность с
бикубической интерполяцией (наилучшая).<br>


<var>pixaspect</var>
- аспект (вытянутость)пиксела(по умолчанию= 1.0);<br>


<var>matchfields</var>
- подогнать ли вертикальное положение полей чересстрочного клипа для
сохранения порядка полей,<br>
&nbsp;&nbsp;&nbsp;
лучшего шумопонижения и т.п. (по умолчанию = true)<br>


<var>mirror</var>
- режим заполнения пустых краев зеркально отраженными от границ кадра
пикселами (вместо черных):<br>
&nbsp;&nbsp;&nbsp;
0 - нет отражения (по умолчанию);<br>
&nbsp;&nbsp;&nbsp;
1 - верх;<br>
&nbsp;&nbsp;&nbsp;
2 - низ;<br>
&nbsp;&nbsp;&nbsp;
4 - лево;<br>
&nbsp;&nbsp;&nbsp;
8 - право;<br>
&nbsp;&nbsp;&nbsp;
сумма любых вышеуказанных - комбинация (15 - все ).<br>

<var>blur</var> -
блюрить отраженные зоны с заданной максимальной длиной размывания (по
умолчанию=0, не блюрить; &nbsp; хорошие значения выше 30)<br>

<var>info</var>
- показать ли информацию по компенсации движения на кадре ( по
умолчанию= false,
нет);<br>

<var>inputlog</var>
- имя входного лог-файла с информацией по движению в формате Deshaker
(по умолчанию - не читать)<br>
</p>
<p>
Замечание. Параметр <var>offset</var>
функции DePan является расширенной версией параметра "<var>delta</var>"
плагина GenMotion.</p>

<h3>Функция DePanInterleave</h3>

<p>
 Генерирует длинный клип с чередующимися группами компенсированных
кадров в следующем порядке:<br>
один или несколько (в некотором диапазоне)
предыдущих компенсированных кадров ,<br>
оригинальный
кадр, один или несколько (в некотором диапазоне) последующих
компенсированных кадров,<br>
 далее такая же группа для следующего кадра и т.д.</p>

<p>Фактически,
функция <var>DePanInterleave</var>
комбинирует функцию <var>DePan</var>
и функцию <var>Interleave</var>
(встроенную в Avisynth) для
удобной подготовки к динамическому шумопронижению, с 
последующей функцией <code><a href="../corefilters/selectevery.htm">
SelectEvery</a>(prev+next+1, prev)</code>
для выбора только оригинальных (но очищенных) кадров.</p>

<h4>Вызов и параметры DePanInterleave подобны
параметрам DePan:
</h4>

<p><code>DePanInterleave</code> (<var>clip,
clip data, int prev, int next, int subpixel, float pixaspect,
bool matchfields, int mirror, int blur, bool info, string inputlog</var>)<br>
</p>

<h4>Параметры DePanInterleave</h4>
<p>
<var>clip</var>
- входной клип (тот же самый что и для DePanEstimate);<br>


<var>data</var>
- специальный служебный клип с данными по движению, производимый
DePanEstimate;<br>


<var>
prev</var>
- число предыдущих кадров (полей) в группе для
компенсации движения 
(целое, по умолчанию =1);<br>

<var>next</var>
- число последующих кадров (полей) в группе для
компенсации движения 
(целое, по умолчанию =1);<br>

<var>subpixel</var>
- точность интерполяции пикселов (точек) при компенсации движения (по
умолчанию = 1):<br>
&nbsp;&nbsp;&nbsp;
0 - по ближайшему исходному пикселу, без интерполяции (быстрая);<br>
&nbsp;&nbsp;&nbsp; 1 - субпиксельная точность с билинейной
интерполяцией (сглаженная, оптимально для понижения шума);<br>
&nbsp;&nbsp;&nbsp; 2 - субпиксельная точность с
бикубической интерполяцией (наилучшая).<br>


<var>pixaspect</var>
- аспект (вытянутость) пиксела (по умолчанию= 1.0);<br>


<var>matchfields</var>
- подогнать ли вертикальное положение полей чересстрочного клипа для
сохранения порядка полей,<br>
&nbsp;&nbsp;&nbsp;
лучшего шумопонижения и т.п. (по умолчанию = true)<br>


<var>mirror</var>
- режим заполнения пустых краев зеркально отраженными от границ кадра
пикселами (вместо черных):<br>
&nbsp;&nbsp;&nbsp;
0 - нет отражения (по умолчанию);<br>
&nbsp;&nbsp;&nbsp;
1 - верх;<br>
&nbsp;&nbsp;&nbsp;
2 - низ;<br>
&nbsp;&nbsp;&nbsp;
4 - лево;<br>
&nbsp;&nbsp;&nbsp;
8 - право;<br>
&nbsp;&nbsp;&nbsp;
сумма любых вышеуказанных - комбинация (15 - все ).<br>

<var>blur</var> -
блюрить отраженные зоны с заданной максимальной длиной размывания (по
умолчанию=0, не блюрить;   хорошие значения выше 30)<br>

<var>info</var>
- показать ли информацию по компенсации движения на кадре ( по
умолчанию= false, нет);<br>

<var>inputlog</var>
- имя входного лог-файла с информацией по движению в формате Deshaker
(по умолчанию - не читать)<br>
</p>
<h3>&nbsp;&nbsp;&nbsp;
Функция DePanStabilize</h3>

<p>&nbsp;Делает частичную стабилизацию движения
путем сглаживания смещений.</p>

<h4>Вызов:</h4>

<p><code>DePanStabilize</code> (<var>clip,
clip data, float cutoff, float damping, float initzoom, bool addzoom, int prev, int
next, int mirror, int blur, int dxmax, int dymax, float zoommax, float
rotmax, int subpixel, float pixaspect,  int fitlast, float
tzoom, bool info, string inputlog, int method</var>)
</p>

<h4>Параметры DePanStabilize:</h4>

<p>
<var>clip</var>
- входной клип (тот же самый что и для DePanEstimate);<br>

<var>data</var>
- специальный служебный клип с данными по движению, производимый
DePanEstimate;<br>

<var>
cutoff</var>
- частота среза подавляемых вибраций, Герц (по умолчанию = 1.0);<br>

<var>damping</var>
- относительный коэффициент демпфирования (по умолчанию = 0.9);<br>

<var>initzoom</var>
- начальный (минимальный) зум для заполнения краев (по умолчанию=1.0);<br>

<var>addzoom</var>
- добавить адаптивный зум для заполнения краев (по умолчанию=false);<br>


<var>
prev</var>
-  максимальное отстояние некоторого предыдущего кадра, используемого для
заполнения краев <br>
&nbsp;&nbsp;&nbsp;&nbsp;
0  - не заполнять (по умолчанию);<br>
&nbsp;&nbsp;&nbsp;
1 - использовать ближайший предыдущий (n-1)  кадр
для заполнения,<br>
&nbsp;&nbsp;&nbsp;
2 - использовать отстоящие на 2 кадры (n-2),<br>
&nbsp;&nbsp;&nbsp;
и т.д.<br>


<var>next</var> -  максимальное отстояние некоторого  будущего кадра,
используемого для заполнения краев <br>
&nbsp;&nbsp;&nbsp;&nbsp;
0  - не заполнять (по умолчанию);<br>
&nbsp;&nbsp;&nbsp;
1 - использовать ближайший  следующий
(n+1) кадр для заполнения,<br>
&nbsp;&nbsp;&nbsp;
2 - использовать отстоящие на 2 кадры (n+2),<br>
&nbsp;&nbsp;&nbsp;
и т.д.<br>


<var>mirror</var>
- режим заполнения пустых краев зеркально отраженными от границ кадра
пикселами (вместо черных):<br>
&nbsp;&nbsp;&nbsp;
0 - нет отражения (по умолчанию);<br>
&nbsp;&nbsp;&nbsp;
1 - верх;<br>
&nbsp;&nbsp;&nbsp;
2 - низ;<br>
&nbsp;&nbsp;&nbsp;
4 - лево;<br>
&nbsp;&nbsp;&nbsp;
8 - право;<br>
&nbsp;&nbsp;&nbsp;
сумма любых вышеуказанных - комбинация (15 - все ).<br>


<var>blur</var> - максимальная длина размывания (блюра) отраженных зон (по
умолчанию=0, не блюрить; хорошие значения выше 30)<br>

<var>dxmax</var>
- предел горизонтальной коррекции, в пикселах (по умолчанию= 60);<br>


<var>dymax</var>
- предел вертикальной коррекции, в пикселах (по умолчанию= 30);<br>


<var>zoommax</var>
- предел коррекции зума (только адаптивный зум, по умолчанию= 1.05);<br>


<var>rotmax</var>
- предел коррекции поворота, в градусах (по умолчанию= 1.0);<br>

&nbsp;&nbsp;&nbsp; значения данных пределов ограничивают коррекцию (c версии 1.7 - приблизительно, нестрого ) <br>
&nbsp;&nbsp;&nbsp; Если отрицательные, то абсолютное значение являтся порогом для новой стабилизации с этого кадра.<br>
 

<var>subpixel</var>
- точность интерполяции пикселов (точек) при компенсации движения (по
умолчанию = 2):<br>
&nbsp;&nbsp;&nbsp;
0 - по ближайшему исходному пикселу, без интерполяции (быстро);<br>
&nbsp;&nbsp;&nbsp; 1 - субпиксельная точность с билинейной
интерполяцией (сглаженно);<br>
&nbsp;&nbsp;&nbsp; 2 - субпиксельная точность с
бикубической интерполяцией (наилучше).<br>


<var>pixaspect</var>
- аспект (вытянутость) пиксела (по умолчанию = 1.0);<br>


<var>fitlast</var>
- подгонка последних кадров к оригинальным позициям (интервал, по
умолчанию=0);<br>


<var>tzoom</var> - время подъема адаптивного зума, секунд (по умолчанию=3.0);<br>

<var>info</var>
- показать ли информацию по стабилизации движения на кадре ( по
умолчанию= false,
нет);<br>


<var>inputlog</var>
- имя входного лог-файла с информацией по движению в формате Deshaker
(по умолчанию - не читать)<br>
<var>
method</var> - используемый метод стабилизации:<br>
&nbsp;&nbsp;&nbsp; 0 - инерциальный (по умолчанию);<br>
Ряд параметров (в том числе <var>dxmax, dymax, rotmax, zoommax, fitlast</var>) используются только в этом методе <br>.
&nbsp;&nbsp;&nbsp; 1 - двунаправленного усреднения;<br> 
&nbsp;&nbsp;&nbsp; 2 - неограниченная (статическая) стабилизация;<br>
&nbsp;&nbsp;&nbsp; -1 - следящее движение (трекинг) базового (первого) кадра вместо стабилизации<br>
</p>
<h3> &nbsp;&nbsp;&nbsp;
Функция DePanScenes</h3>

<p>Генерирует клип со значениями пикселов =255 для определенной плоскости
для кадра при смене сцены и  =0 для других кадров,<br>
используя данные по движению, определенные DePanEstimate.</p>

<p> Может
быть использована функцией типа <var>AverageLuma</var>
для условной обработки.</p>

<h4>Вызов:</h4>

<p><code>DePanScenes</code> ( <var>clip, string inputlog, int plane</var>)</p>

<h4>Параметры DePanScenes:</h4>

<p>
<var>clip</var>
-входной клип специальный клип с данными по движению,
производимый  DePanEstimate)<br>


<var>inputlog</var>
- имя входного лога в формате Deshaker  (по умолчанию - не
читать)<br>


<var>plane</var>
- код плоскости с отметкой (1 - Y, 2 - U, 4 - V, сумма - комбинация,
по умолчанию=1) <br>
</p>
<h2>&nbsp;&nbsp;
Особенности и ограничения текущей версии плагина DePan  </h2>

<p>1. Работает только в форматах цвета YV12 и YUY2.</p>

<p>2. Оценивает только смещения (панорамирование) и зум (не вращение), но
это дает преимущества по
скорости и стабильности. Оценка зума не очень точна.</p>

<p>3. Исходный клип должен иметь ту же длину что и клип с данными
по движению.</p>

<p>4. Прямо работает только с прогрессивными клипами. Для
чересстрочных источников, вы должны использовать предшествующую
Avisynth-команду <code>SeparateFields </code>и
последующую <code>Weave</code>
(после компенсации движения и шумопонижения), с  <code>AssumeTTF</code>
и <code>AssumeBFF.</code>   
Плагин оценивает и вычисляет движение от одного поля к соседнему (по
времени) полю (из того же или следующего кадра). Для
сохранения порядка (доминантности) полей и наилучшего шумопонижения,
установите параметр <var>MatchFields</var>=true.</p>

<p>5. Режим <var>mirror</var>(зеркало) является
уникальным, но немного странным :-). Используйте blur чтобы
скрыть резкие отраженные детали. Замечание: blur пока не реализован для вращения.</p>

<p>6. Не очень быстрый, без оптимизации ассемблером моих функций.</p>

<p>7. Тестирован с версиями Avisynth 2.5.3, 2.5.4, 2.5.5, 2.5.6, 2.5.7, 2.5.8, 2.6.0.</p>

<p>8. Старые версии использовали открытый FFT2D код Takuya Ooura
(<cite><a href="http://momonga.t.u-tokyo.ac.jp/%7Eooura/index.html">http://momonga.t.u-tokyo.ac.jp/~ooura/index.html</a>)</cite><br>
Теперь DePanEstimate использует только более быструю библиотеку
FFTW версии 3 (<cite><a href="http://www.fftw.org">http://www.fftw.org</a></cite>)<br>
как Windows бинарную DLL (скомпилированную gcc под MinGW by Alessio
Massaro),<br>
которая поодерживает нити (потоки) и  AMD K7 (3DNow!) в добавок к
SSE/SSE2.<br>
Она может быть загружена с 
<cite><a href="ftp://ftp.fftw.org/pub/fftw/fftw3win32mingw.zip">ftp://ftp.fftw.org/pub/fftw/fftw3win32mingw.zip</a></cite><br>
<font color="#ff0000">Для использования <var>fftw</var>
, вы должны положить FFTW3.DLL файл из пакета в некоторый каталог в
путях (например, C:\WINNT\SYSTEM32). DePanEstimate не будет работать без этого!</font></p>

<p>9. Для лучших результатов, вы можете временно добавить параметр <var>Info</var>,
анализировать информацию и подобрать значения параметров <var>Trust</var> и т.п. </p>

<p>10. Вы также можете использовать не строго одинаковые клипы для оценки
движения и для компенсации, например
попробовать добавить предварительную фильтрацию, подстройку
яркости-контраста, маскирование, обрезку клипа, используемого
для оценки движения (и использовать другую обработку для
выходного компенсируемого-стабилизировуемого клипа).<br>
</p>

<h2>Использование</h2>

<h3>Использование для подготовки компенсированного клипа чередования с последующим
сильным динамическим шумопонижением</h3>

<p>
1. Загрузите оригинальный (входной) клип (I),<br>
2. Сделайте клип (F) с полной компенсацией вперед, <br>
3. Сделайте клип (B) с полной компенсацией назад,<br>
4. Сделайте клип чередования, с компенсированными кадрами перед и после
каждого оригинального кадра;<br>
Вы получите длинный клип (с утроенной длиной), с каждыми тремя
последовательными кадрами, соответствующими тому же времени.<br>
5. Примените некоторый динамический фильтр, который использует разницу
пикселов между предыдущим,<br>
текущим и следующим кадром в группе, например фильтр <code>Fluxsmooth</code> .<br>
6. Выберите каждый третий (оригинальный не-компенсированный но
очищенный) кадр на выход. Очищенный клип не будет иметь много артефактов, производимых глобальным
движением с шумопонижением, и
шумопонижение будет более сильным в большинстве областей (благодаря
компенсации движения).
 </p>

<p>Замечание:
с <code>DePanInterleave</code>,
стадии 2,3,4 объединены в единую. Кроме того, радиус может быть больше
чем 1.</p>

<h4>
Простой пример скрипта для прогрессивного клипа::</h4>

<pre>Avisource("input.avi")
LoadPlugin("depanestimate.dll") # или используйте автозагрузку
LoadPlugin("depan.dll")         # или используйте автозагрузку
loadplugin("fluxsmooth.dll")
i=converttoYV12()
mdata=DePanEstimate(i)
DePanInterleave(i,data=mdata)
fluxsmooth()
selectevery(3,1) </pre>

<h4>Пример
скрипта для чересстрочного
клипа:</h4>

<pre>Avisource("input.avi")
LoadPlugin("depanestimate.dll") # или используйте автозагрузку
LoadPlugin("depan.dll")         # или используйте автозагрузку
loadplugin("fluxsmooth.dll")
converttoYV12()
AssumeTFF()
i=SeparateFields()
mdata=DePanEstimate(i, range=1,trust=5.5, log="depan.log")
DePanInterleave(i,data=mdata, prev=1, next=1, matchfields=true)
fluxsmooth()
selectevery(3,1)
Weave()
</pre>

<p>Можно и разделить клип на четные и нечетные поля, или использовать
bob-деинтерлейс с последующим восстановлением.</p>

<h4> 
Некоторые подходящие динамические (темпоральные) фильтры</h4>

<ul>
  <li>CTMedian (Conditional Temporal Median) by Kevin Atkinson </li>
  <li> 
и его новая моя версия переименованная в DeSpot </li>
  <li>STMedianFilter by Tom Barry - trbarry@trbarry.com</li>
  <li>FluxSmooth by Ross Thomas &lt;ross@grinfinity.com&gt;</li>
  <li>RemoveDirt
by Rainer Wittmann gorw@gmx.de</li>
  <li>DeGrainMedian
(by Fizick)</li>
</ul>

<p>Тестируйте, чтобы пополнить список!</p>

<p>Для
предложенного метода фильтрации с DePan (ранее с GenMotion),<br>
такой временной фильтр должен сравнивать пиксел с предыдущим и последующим кадром,<br>
и делать сглаживание только если разница между предыдущим и последующим мала.<br>
Эти фильтры также могут выполнять дополнительную (локальную) компенсацию
остаточного движения</p>

<h3>&nbsp;&nbsp;&nbsp;
Использование DePan для изменения частоты кадров</h3>

<p>DePan 
может быть использован как средство для преобразования частоты кадров и
подобных задач.</p>

<p>Например,
чтобы изменить частоту кадров в 1,5 раза, из 16.666
fps (прогрессивный старый 8 мм кинофильм) в 25 fps,<br>
можно применить скрипт:</p>

<pre>loadplugin("depan.dll")
LoadPlugin("depanestimate.dll") # или используйте автозагрузку
Avisource("kino.avi")
data=DePanEstimate(i,range=1,trust=5)
i=ConvertToYV12()
f1_3=DePan(i,data,offset=1./3)
b1_3=DePan(i,data,offset=-1./3)
interleave(f1_3,i,b1_3)
selectevery(6,0,1,2)
 </pre>

<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Это может быть записано с использованием функции:</p>

<pre>function fps2to3(clip) {
# change FPS from 2 to 3 (or 16.66 to 25, or 20 to 30 and so on), i.e. with factor=3/2
# uses global motion compensation
# input must be YV12 or YUY2 progressive (or separated fields probably ?)
data = DePanEstimate(clip)
f1_3 = DePan(clip, data, offset=1./3)
b1_3 = DePan(clip, data, offset=-1./3)
Interleave(f1_3, clip, b1_3)
SelectEvery(6, 0, 1, 2)
}

AviSource("e:\video.avi")
LoadPlugin("depanestimate.dll")         # или используйте автозагрузку
LoadPlugin("depan.dll")
ConvertToYV12()
fps2to3()
</pre>
<p>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Вот
возможная функция для преобразования частоты кадров (прогрессивных) с
фактором=5/3, например из 15 fps в 25 fps :
</p>
<pre>function fps3to5(clip) {
# change FPS from 3 to 5 (or 15 to 25, or 18 to 30 and so on), i.e. with factor=5/3
# uses global motion compensation
# input must be YV12 or YUY2 progressive (or separated fields probably ?)
data = DePanEstimate(clip)
t3_5 = DePan(clip, data, offset=-2./5)
t6_5 = DePan(clip, data, offset=1./5).trim(2,0)
t9_5 = DePan(clip, data, offset=-1./5).trim(1,0)
t12_5 = DePan(clip, data, offset=2./5).trim(3,0)
Interleave(clip, t3_5, t6_5, t9_5, t12_5)
SelectEvery(15,0,1,2,3,4)
}

AviSource("e:\video.avi")
LoadPlugin("depanestimate.dll")         # или используйте автозагрузку
LoadPlugin("depan.dll")
ConvertToYV12()
fps3to5()
</pre>

<p>Замечание. Есть более простой и общий альтернативный способ смены частоты:
 попробуйте функцию <code>ChangeFPS</code> с последующим <code>DePanStabilize</code>
</p>


<h3>&nbsp;&nbsp;&nbsp;
Использование DePan для стабилизации движения</h3>

<p>DePan 
может быть использован как средство для сглаживания глобального
движения (тряски).   </p>

<p>Простой
пример скрипта для
стабилизации прогрессивного клипа::</p>

<pre>Avisource("input.avi")
LoadPlugin("depanestimate.dll")         # или используйте автозагрузку
loadplugin("depan.dll")
i=converttoYV12()
mdata=DePanEstimate(i)
DePanStabilize(i,data=mdata)</pre>

<p>Вы можете добавить и настроить параметры 
определяющие частоту среза (<var>Cutoff</var>),
метод заполнения пустых краев и т.д., наиболее
соответствующие вашему клипу.</p>

<h3>Детектирование и протоколирование смены сцен</h3>
<p>Создает файл с номерами кадров при смен сцен. Проиграйте весь клип.</p>
<pre>
LoadPlugin("depanestimate.dll") # или автозагрузкой
LoadPlugin("depan.dll")         # или автозагрузкой
filename="test.log"
avisource("g:\test.avi")
ConvertToYV12(interlaced=false)
data=DepanEstimate(trust=2.5)
WriteFileIf(filename, "(AverageLuma(DepanScenes(data))>30)" , "current_frame")
</pre>

<h3>Использование лог-файлов </h3>

<p>
&nbsp;&nbsp;&nbsp; Функция DepanEstimate может создавать
выходной лог файл с данными по движению,&nbsp; в формате совместимом с плагином Deshaker.</p>

<p>
Кроме того, Depan может читать такие лог файлы (в этом режиме он
работает как плагин GenMotion, без DepanEstimate, клип с данными игнорируется, и тогда в качестве
такого ложного клипа&nbsp; может быть использован исходный клип ).</p>

<p>
Файл лога Deshaker может быть загружен в Depan и наоборот. 
Depan также может компенсировать зум и вращение.</p>

<p>Следовательно,
вы можете загрузить подобные AVS скрипт файлы в VirtualDub, 
и выполнить второй проход Deshaker для продвинутой стабилизации
движения (и кодирования) отфильтрованного клипа. Конечно,
перед этим вы должны прогнать первый проход DePanEstimate чтобы сделать
лог файл, который
будет указан в Deshaker.<br>
Вместо этого, вы можете добавить в скрипт функцию
<code>DePanStabilize(i,data)</code> 
и выполнить все (оценку
движения, компенсацию движения, шумопонижение и стабилизацию движения)
в один проход !</p>

<p>С версии 1.9.2 возможно записать расширенный лог-файл с дополнительной информации о параметре корреляции "Trust" для кадров.
</p>


<h4>  Формат лог файла Deshaker (Gunnar Thalin)</h4>

<p>
&nbsp;&nbsp;&nbsp; В течение первого прохода, Deshaker
пытается найти величины перемещений, поворота и зума, которые, 
приложенныек текущему кадру, делают его похожим на предыдущий.<br>
В файле информация записана по строке на кадр, в фиксированном текстовом
формате (слева направо):<br>
номер кадра (или поля), x- и y- смещение (в пикселах),
поворот (в градусах) и множитель зума.<br>
Вы можете редактировать лог файл вручную
(но в строго фиксированном формате).<br>
Вы можете
также удалить строки, которые полностью ошибочны
(Deshaker тоже ошибается).<br>
Отсутствие
строки с некоторыми номерами кадров трактуются как нулевое движение.<br>
Если есть
строки с теми же номерами кадров, используется последняя. Все как в самом Deshaker.
<br>
Замечание. Для чересстрочного формата, информация пишется для каждого
поля (A - первое по времени, B - второе).</p>

<h3>
&nbsp;&nbsp;&nbsp;
Формат кадрового буфера DePan и Depanestimate для обмена клиент-сервер  (в
основном для программистов)</h3>

<p>
Depan использует фрейм-буфер специального клипа для хранения данных по
движению.</p>

<p>
Когда клиент (depan) запрашивает данные по движению для кадра <code>n</code> из
этого клипа,  сервер (DepanEstimate) создает кадр и пишет в него нужные данные (в
начало фрейм-буфера): заголовок, и несколько записей по движению для кадров, от <code>n-range</code>
до <code>n+range</code> (<code>nframes
= 2*range+1</code>
для некрайних кадров).</p>

<p>
Определение данных по движению такое же, как в логе Deshaker.</p>

<p>
Я использую следующие структуры в текущей версии:</p>

<pre>#define DEPANSIGNATURE "depan06"

typedef struct depanheaderstruct { // structure of depandata header in framebuffer
char signature[8]; // signature for check of data valid
int reserved; // for future using
int nframes; // number of records with frames motion data in current framebuffer
} depanheader;

typedef struct depandatastruct { // structure of every frame motion data record in framebuffer
int frame; // frame number
float dx; // x shift (in pixels) for this frame
float dy; // y shift (in pixels, corresponded to pixel aspect = 1)
float zoom; // zoom
float rot; // rotation (in degrees), (now =0 - no rotation estimated data in current version)
} depandata;
</pre>


<p>Замечание 1. Depan использует значение dx=0.0 как признак смены сцены.</p>
<p>Замечание 2. Выходные кадры DepanEstimate
обрезаны, если не включен режим просмотра.</p>

<h3>
&nbsp;&nbsp;&nbsp;
Альтернативный метод оценки глобального движения</h3>

<p>
&nbsp;&nbsp;&nbsp;
Некоторое время назад я добавил  в плагин оценки локального
движения MVTools от Manao (с версии 0.9.8.2) новую функцию MVDepan оценки глобального
движения.
Она работает на
основе анализа векторов движений малых блоков, подобно первому проходу плагина Deshaker.
Функция MVDepan (и MDepan версии 2)
может быть использована вместо функции DePanEstimate.
Она может
оценивать панорамирование, зум и вращение. 
</p>

<h3>
&nbsp;&nbsp;&nbsp;
Дополнительная информация о DePan</h3>


<p>Некоторая
дискуссия о плагинах GenMotion и DePan и смежных вопросах может быть
найдена на форуме AviSynth<br>
<cite><a href="http://forum.doom9.org/forumdisplay.php?s=&amp;forumid=33">http://forum.doom9.org/forumdisplay.php?s=&amp;forumid=33</a></cite><br>
и в частности в ветке <cite><a href="http://forum.doom9.org/showthread.php?s=&amp;threadid=66686">http://forum.doom9.org/showthread.php?s=&amp;threadid=66686</a></cite></p>

<p>
Или обращайтесь на русскоязычный форум <cite><a href="http://forum.ixbt.com">http://forum.ixbt.com</a></cite>,
конференция по видеозахвату,<br>
ветка "Экстремальный Ависинт" <cite><a href="http://forum.ixbt.com/topic.cgi?id=29:9331">
http://forum.ixbt.com/topic.cgi?id=29:9331 </a></cite></p>

<h3>
&nbsp;&nbsp;&nbsp;
Благодарности</h3>
<p> Благодарю Gunnar Thalin за детальную информацию о формате лог-файла Deshaker
и очень полезные обсуждения.
</p>
<p> Благодарю Takuya Ooura за
возможность использования свободного и быстрого кода FFT2D.</p>

<p>
 Благодарю <b>scharfis_brain</b>
и многих других за полезные обсуждения и доклады об ошибках.<br>
</p>

<h3>&nbsp;&nbsp;&nbsp;
История версий:
</h3>

<ul>
  <li>Версия 0.1,  25 Апреля 25, 2004 - первая публичная бета.<br>

  </li>
  <li>Версия 0.2,  27 Апреля , 2004 - исправлен баг для нецелых
величин <var>Offset</var>.<br>

  </li>
  <li>Версия 0.3,  7 Мая, 2004 - исправлен баг с DePanStabilize
входными параметрами, изменено <var>subpixel</var>=2
по умолчанию, 
добавлена оценка зума и параметр <var>ZoomMax</var>,
компенсация зума и вращения, 
чтение лог файла, параметр MatchFields.<br>

  </li>
  <li>Версия 0.4, 16 Мая,
2004 - исправлен баг с <var>MatchFields</var>
для больших значений <var>Offset</var>,<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
исправлен баг с позицией пиксела для проекции ближайших пикселов и
билинейной интерполяции,<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
изменено <var>MatchFields</var>=true
по умолчанию, добавлен аспект пиксела, добавлена русская документация.</li>
  <li>
Версия 0.5, 22 Мая, 2004 -  исправлен баг с вращением в Depan,<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
улучшена DepanStabilize: изменен метод стабилизации на инерциальный в
широком диапазоне,<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
добавлены параметры <var>freqmax</var>,
    <var>dxmax</var>,
    <var>dymax</var>,
    <var>zoommax</var>,
    <var>rotmax</var>,
    <var>inputlog</var>.</li>
  <li>
Версия 0.6, 28 Мая 2004 - немного изменен и документирован
клиент-сервер формат,<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
DepanEstimate: добавлен параметр <var>Stab</var>,
смена сцены при резких изменениях корреляции, <var>Range</var>
может быть 0, показ корреляции, обрезка
выхода.<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
DepanStabilize: <var>Freqmax</var>
переименован в <var>Cutoff</var>,
добавлен адаптивный зум, заполнение краев смежными кадрами.</li>
  <li>
Версия 0.7, 30 Мая 2004 - DepanEstimate: добавлено улучшение оценки
зума (<var>Improve</var>)
путем итерации .</li>
  <li>
Версия 0.8, 6 июня 2004 - DepanInterleave: параметр <var>Range</var>
заменен на <var>Prev</var>
и <var>Next</var>.</li>
  <li>
Версия 0.9, 13 июня 2004 - все клиенты : добавлен параметр <var>Mirror</var>
для зеркального заполнения пустых краев.</li>
  <li>
Версия 0.9.1, 24 августа 2004 - исправлены баги с оценкой и
компенсацией зума.</li>
  <li>
Версия 1.0, 3 сентября 2004 - добавлена опция использования внешней
библиотеки FFTW (более быстрой) .</li>
  <li>
Версия 1.1, 16 сентября, 2004 - Добавлена экспериментальная функция
DepanScenes. </li>
  <li>
Версия 1.1.1, 07 октября, 2004 - Исправлена ошибка компенсации у правых
верхнего и нижнего углов,<br>

&nbsp;&nbsp;&nbsp;&nbsp; изменено с FFTW_MEASURE на
FFTW_ESTIMATE для более короткой инициализации, без заметного изменения
скорости (для окон степени 2),<br>

&nbsp;&nbsp;&nbsp;&nbsp; компиляция без флага /G7 (как
было до версии 1.0), добавлены в документацию скриптовые FPS функции.
(не публичная)</li>
  <li>
Версия 1.1.2, 09 октября, 2004 - Задержанная загрузка fftw3.dll (теперь
опциональной).&nbsp;</li>
  <li>
Версия 1.1.3, 16 ноября, 2004 - Исправлена ошибка с бесконечным смещением в
DepanStabilize.</li>
  <li>
Версия 1.1.4, 15 декабря, 2004 - параметр <var>damping</var>
в DepanStabilize теперь изменяемый (был случайно фиксирован = 0.9 во
всех предыдущих версиях :-).
Добавлена заметка о MVDepan в
документацию.</li>
  <li>
Версия 1.1.5, 31 декабря, 2004 - Исправлена ошибка в DepanEstimate
(неверные результаты) для <var>fftw</var>=true
с <var>show</var>=false
и <var>info</var>=false
</li>
  <li>
Версия 1.2, 1 апреля 2005 - добавлен параметр
    <var>fitlast</var> для
подгонки последких кадров к оригинальным позициям</li>
  <li>
Версия 1.3, 29 апреля 2005 - добавлен параметр <var>blur</var> для
некоторого скрытия резких отраженных деталей путем размазывания; пока блюр только
горизонтальный, у левой и правой сторон кадра.
  </li>

  <li>
Версия 1.4, 7 мая 2005 (обнародована 29 мая) - DePanStabilize: Улучшен режим адаптивного зума <var>addzoom</var>.
Теперь скорость снижения адаптивного зума более медленная, чем скорость
увеличения. Таким образом, уменьшаются пустые черные бордюры, и
величина зума теперь более стабильна. 
  </li>

  <li>Версия
1.4.1, 30 мая 2005 - DepanEstimate: исправлена ошибка с лог-файлом
(символы A и B перепутаны) для BFF (все предыдущие версии). Спасибо <b>eugvas</b> за доклад. </li>
  <li>
Версия 1.5, 4 июня 2005 - улучшен адаптивный зум; добавлен параметр <var>tzoom</var> для
задания времени подъема адаптивного зума (был равен 1/<var>cutoff</var>).
  </li>
  <li>
Версия 1.6, 5 августа 2005 - добавлена поддержка YUY2; отменен режим <var>improved=true</var> (был неисправен); 
изменено значение по умолчанию <var>subpixel</var>=1 для DepanInterleave 
как достаточное для понижения шума и более быстрое.<br> 
  </li>
  <li>
Версия 1.7, 5 сентября 2005 - DePanStabilize: добавлен параметр <var>initzoom</var> для минимального зума; <br>
изменены пороги <var>dxmax, dymax, zoommax, rotmax</var> с жестких на мягкие с большей крутизной нелинейности.<br>
Изменен кэш.
  </li>
  <li>
Версия 1.8, 14 марта, 2006 - DePanEstimate: установил FFTW по умолчанию если есть, FFTW_MEASURE, небольшая  iSSE оптимизация<br>
DePanStabilize: добавлены (недокументированные :-) строковые параметры <var>vdx, vdy, vzoom, vrot</var> для переменных AviSynth как просил AI.<br>
Исправил ошибку с subpixel=1 YUY2 режимом (доступ к памяти при обновлении).
  </li>
  <li>
Версия 1.8.1, 8 мая, 2006 - DePanStabilize: теперь стабилизирует и зум.
  </li>
  <li>
Версия 1.8.2, 5 июня 2006 - DePanStabilize: теперь стабилизирует зум на коротком интервале;<br>
Исправил старую ошибку с вращением.<br>
DePanEstimate: dx или dy=0 теперь означают не оценивать движение вдоль этой координаты.
  </li>
  <li>
Версия 1.8.3, 11 июня 2006 - DePanStabilize: теперь prev и next определяют максимальное отстояние.<br>
  </li>
  <li>
Version 1.9.0, 13 Ноября, 2006 - Выделил функцию DePanEstimate в отдельный плагин DePanEstimate.dll (под GNU GPL),
удалил не-fftw код (теперь всегда fftw=true).
  </li>
  <li>
Version 1.9.1, 27 Ноября, 2006 - DePanEstimate: более корректная обработка dxmax=0 или dymax=0
  </li>
  <li>
DePanEstimate Version 1.9.2, 25 марта 2007 - DePanEstimate: параметр <var>extlog</var>
 для записи расширенного лог-файла с данными Trust (как просил David). 
  </li>
  <li>
DePan Version 1.10 beta, 8 мая 2007 - DepanStabilize:  добавлен новый <var>method</var> усреднения,<br>
исправлена небольшая ошибка в интерполяции краев.
 </li>
  <li>
DePan Version 1.10.1, 27 января 2008 - исправлена ошибка с <var>blur</var> для <var>subpixel=1</var>.
 </li>
  <li>
5 августа 2011 - выложены исходники Depan по лицензии GPL v2.
 </li>
  <li>
DePan Version 1.12, 31 января 2016 - стабилизация второго кадра после смены сцены, небольшие исправления.
 </li>
  <li>
DePan Version 1.13, 18 февраля 2016 - Экспериментальные method=2 (неоганиченной стабилизации) и method=-1 (сопровождения) для DepanStabilize.
 </li>
  <li>
DePanEstimate v1.10, 22 февраля, 2016 - DePanEstimate: добавил wleft, wtop, удалил improve. 
Исправил документацию о значении по умолчанию range, stab (спасибо HolyWu).
 </li>
  <li>
DePan Version 1.13.1, 6 апреля 2016 - Исправил старую ошибку (оттенок) для subpixel=2  без вращения и зума (Depan, DepanStabilize).
 </li>
</ul>

<h3>
&nbsp;&nbsp;&nbsp;
Лицензия</h3>

<p>Плагины Depan и DePanEstimate - это программы, распространяемая на условиях лицензии GNU GPL. Смотри gpl-rus.txt.<br>
Покументация распространяется на условиях лицензии <a href="http://creativecommons.org/licenses/by-sa/3.0/">CreativeCommons BY-SA 3.0 license.</a><br>
<p>Прошу рассмотреть возможность финансовой <a href="http://avisynth.org.ru/donate-rus.html">поддержки</a>.</p>

<h3>Скачивание</h3>

<p><a href="depan1131.zip">Download DePan tools version 1.13.1</a></p>
<p><a href="depanestimate110.zip">Download DePanEstimate version 1.10</a></p>

<p>
<a href="../">Вернуться
на главную страницу</a></p>

</body></html>               